{% extends "base.html" %}

{% block content %}
<style>
    /* Prevent layout jump while charts initialize */
    .page-loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(6px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 200ms ease;
    }

    .page-loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .page-loading-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 14px;
        padding: 18px 22px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        display: flex;
        align-items: center;
        gap: 12px;
        color: #333;
        font-weight: 600;
    }

    .spinner {
        width: 18px;
        height: 18px;
        border: 3px solid #e9ecef;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .page-hidden {
        visibility: hidden;
    }

    .player-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .player-avatar-lg {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: 700;
        border: 4px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 18px;
        margin-top: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px 16px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        position: relative;
        min-height: 85px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .stat-card-value {
        font-size: 26px;
        font-weight: 700;
        color: #333;
        margin-bottom: 4px;
        line-height: 1.2;
    }

    .stat-card-subvalue {
        font-size: 11px;
        color: #999;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .stat-card-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        line-height: 1.2;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        margin: 35px 0 15px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .chart-box {
        position: relative;
        width: 100%;
        height: 280px;
    }

    .chart-box.chart-box--md {
        height: 240px;
    }

    .chart-box.chart-box--sm {
        height: 220px;
    }

    .chart-box canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    .game-log-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .game-log-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .game-log-table th {
        padding: 12px 8px;
        font-weight: 600;
        font-size: 12px;
        text-align: center;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .game-log-table td {
        padding: 10px 8px;
        text-align: center;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
    }

    .game-log-table tbody tr:hover {
        background: #f8f9fa;
    }

    .result-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 11px;
    }

    .result-w { background: #d4edda; color: #155724; }
    .result-l { background: #f8d7da; color: #721c24; }

    /* Tooltip styling */
    .stat-tooltip-icon {
        position: absolute;
        top: 6px;
        right: 6px;
        font-size: 10px;
        color: #cbd5e0;
        cursor: help;
    }
    .stat-card:hover .stat-tooltip-icon {
        color: #a0aec0;
    }

    /* Per 40 section styling */
    .per40-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }

    .per40-title {
        font-size: 11px;
        text-transform: uppercase;
        color: #718096;
        margin-bottom: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .per40-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        text-align: center;
    }

    .per40-item {
        background: #f7fafc;
        padding: 10px 8px;
        border-radius: 6px;
    }

    .per40-value {
        font-weight: 700;
        font-size: 18px;
        color: #2d3748;
        line-height: 1.2;
    }

    .per40-label {
        font-size: 10px;
        color: #718096;
        margin-top: 2px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Shot Chart Styles */
    .shot-chart-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
    }
    .shot-point {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid rgba(0,0,0,0.2);
        cursor: pointer;
        transition: transform 0.2s;
        z-index: 10;
        opacity: 0.8;
    }
    .shot-point:hover {
        transform: translate(-50%, -50%) scale(1.5);
        z-index: 20;
        opacity: 1;
    }
    .shot-made {
        background-color: #28a745; /* Green */
    }
    .shot-missed {
        background-color: #dc3545; /* Red */
    }
    .shot-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        display: none;
        z-index: 100;
        white-space: nowrap;
    }
</style>

<!-- Loading overlay -->
<div id="pageLoader" class="page-loading-overlay">
    <div class="page-loading-card">
        <span class="spinner"></span>
        Loading player analytics…
    </div>
</div>

<div id="playerPage" class="container-fluid page-hidden">
    <!-- Player Header -->
    <div class="player-header">
        <div class="d-flex align-items-center gap-4">
            <div class="player-avatar-lg">{{ player_name[:2]|upper }}</div>
            <div style="flex: 1;">
                <h1 style="font-size: 36px; margin: 0;">{{ player_name }}</h1>
                <div class="d-flex align-items-center gap-3 mt-2" style="opacity: 0.9;">
                    <span style="font-size: 18px;"><i class="fas fa-basketball-ball"></i> {{ games_played }} Games</span>
                    <span style="font-size: 18px;"><i class="fas fa-clock"></i> {{ averages.mpg|round(1) }} MIN</span>
                </div>
            </div>
            <div>
                <a href="{{ url_for('main.players', game_type=game_type) }}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Back to Players
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Overview (Key Stats) -->
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.ppg|round(1) }}</div>
            <div class="stat-card-label">Points</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.rpg|round(1) }}</div>
            <div class="stat-card-subvalue">{{ averages.orebpg|round(1) }} Off · {{ averages.drebpg|round(1) }} Def</div>
            <div class="stat-card-label">Rebounds</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.apg|round(1) }}</div>
            <div class="stat-card-label">Assists</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.eff|round(1) }}</div>
            <div class="stat-card-label">Efficiency</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.ortg|round(0) }}</div>
            <div class="stat-card-label">Off Rating</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ averages.ts_pct|round(1) }}%</div>
            <div class="stat-card-label">True Shooting</div>
        </div>
    </div>

    <div class="row">
        <!-- Advanced Metrics Panel -->
        <div class="col-lg-8">
            <div class="section-title">
                <i class="fas fa-calculator" style="color: #667eea;"></i>
                Advanced Metrics Breakdown
            </div>
            
            <div class="row g-3">
                <!-- Scoring Efficiency -->
                <div class="col-md-6">
                    <div class="chart-container h-100">
                        <h6 style="color: #4a5568; font-weight: 700; text-transform: uppercase; font-size: 12px; margin-bottom: 15px;">Scoring & Efficiency</h6>
                        <div class="stat-grid" style="grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 0;">
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.ppp|round(2) }}</div>
                                <div class="stat-card-label">PPP (Pts/Poss)</div>
                            </div>
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.usg_pct|round(1) }}%</div>
                                <div class="stat-card-label">Usage Rate</div>
                            </div>
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.efg_pct|round(1) }}%</div>
                                <div class="stat-card-label">eFG%</div>
                            </div>
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ (averages.consistency * 100)|round(1) }}%</div>
                                <div class="stat-card-label">CV (Consistency)</div>
                            </div>
                        </div>
                        
                        <!-- Per 40 Estimate -->
                        <div class="per40-section">
                            <h6 class="per40-title">Per 40 Minutes Estimate</h6>
                            <div class="per40-grid">
                                <div class="per40-item">
                                    <div class="per40-value">{{ (averages.ppg * (40 / averages.mpg))|round(1) }}</div>
                                    <div class="per40-label">PTS</div>
                                </div>
                                <div class="per40-item">
                                    <div class="per40-value">{{ (averages.rpg * (40 / averages.mpg))|round(1) }}</div>
                                    <div class="per40-label">REB</div>
                                </div>
                                <div class="per40-item">
                                    <div class="per40-value">{{ (averages.apg * (40 / averages.mpg))|round(1) }}</div>
                                    <div class="per40-label">AST</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ball Handling & Shooting Splits -->
                <div class="col-md-6">
                    <div class="chart-container h-100">
                        <h6 style="color: #4a5568; font-weight: 700; text-transform: uppercase; font-size: 12px; margin-bottom: 15px;">Handling & Shooting Splits</h6>
                         <div class="stat-grid" style="grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 0;">
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.ast_tov|round(2) }}</div>
                                <div class="stat-card-label">AST / TOV</div>
                            </div>
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.fta_pct|round(1) }}%</div>
                                <div class="stat-card-label">Free Throw Rate</div>
                            </div>
                            <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.two_pt_pct|round(1) }}%</div>
                                <div class="stat-card-label">2PT FG%</div>
                            </div>
                             <div class="stat-card" style="padding: 12px; min-height: 75px;">
                                <div class="stat-card-value">{{ averages.oreb_pct|round(1) }}%</div>
                                <div class="stat-card-label">Off. Reb %</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
             <div class="section-title">
                <i class="fas fa-chart-line" style="color: #f5576c;"></i>
                Performance Trends (Last 10 Games)
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Scoring History</h5>
                        <div class="chart-box chart-box--md">
                            <canvas id="scoringChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Shooting Efficiency</h5>
                        <div class="chart-box chart-box--md">
                            <canvas id="shootingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shot Chart Section -->
            {% if shot_events %}
            <div class="section-title">
                <i class="fas fa-crosshairs" style="color: #e53e3e;"></i>
                Shot Distribution
            </div>
            <div class="row">
                <div class="col-md-12">
                     <div class="chart-container text-center">
                         <h6 style="color: #4a5568; font-weight: 700; text-transform: uppercase; font-size: 12px; margin-bottom: 15px;">Field Goal Locations (Made Only)</h6>
                         <div class="shot-chart-container" id="shotChartContainer">
                            <!-- Half Court SVG -->
                             <svg viewBox="0 0 500 470" xmlns="http://www.w3.org/2000/svg" style="width:100%; height:auto; background: #e0d4c5; display: block;">
                                <!-- Key Area -->
                                <rect x="170" y="0" width="160" height="190" fill="none" stroke="#fff" stroke-width="2"/>
                                <!-- Hoop -->
                                <circle cx="250" cy="47.5" r="7.5" fill="none" stroke="#ec9c3d" stroke-width="2"/>
                                <!-- Backboard -->
                                <line x1="220" y1="40" x2="280" y2="40" stroke="#fff" stroke-width="2"/>
                                <!-- 3PT Line (simplified arc) -->
                                <path d="M 30,0 L 30,140 A 237.5 237.5 0 0 0 470 140 L 470,0" fill="none" stroke="#fff" stroke-width="2"/>
                                 <!-- Center Circle -->
                                 <circle cx="250" cy="470" r="60" fill="none" stroke="#fff" stroke-width="2"/>
                                 <!-- Free Throw Circle -->
                                 <circle cx="250" cy="190" r="60" fill="none" stroke="#fff" stroke-width="2"/>
                            </svg>
                            <div id="shotLayer"></div>
                         </div>
                     </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Season Bests & Defense Panel -->
        <div class="col-lg-4">
             <div class="section-title">
                <i class="fas fa-trophy" style="color: #fbbf24;"></i>
                Season Bests
            </div>
            <div class="stat-grid" style="grid-template-columns: 1fr; gap: 12px;">
                <div class="stat-card d-flex align-items-center justify-content-between px-4" style="min-height: 70px;">
                    <div class="text-start">
                        <div class="stat-card-label">Points</div>
                        <div class="stat-card-value">{{ career_highs.points }}</div>
                    </div>
                    <i class="fas fa-basketball-ball text-muted opacity-25 fa-2x"></i>
                </div>
                <div class="stat-card d-flex align-items-center justify-content-between px-4" style="min-height: 70px;">
                    <div class="text-start">
                        <div class="stat-card-label">Rebounds</div>
                        <div class="stat-card-value">{{ career_highs.reb }}</div>
                    </div>
                    <i class="fas fa-hand-holding text-muted opacity-25 fa-2x"></i>
                </div>
                <div class="stat-card d-flex align-items-center justify-content-between px-4" style="min-height: 70px;">
                    <div class="text-start">
                        <div class="stat-card-label">Assists</div>
                        <div class="stat-card-value">{{ career_highs.ast }}</div>
                    </div>
                    <i class="fas fa-share text-muted opacity-25 fa-2x"></i>
                </div>
            </div>

            <div class="section-title mt-4">
                <i class="fas fa-shield-alt" style="color: #2f855a;"></i>
                Defense
            </div>
            <div class="stat-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card" style="min-height: 75px;">
                    <div class="stat-card-value">{{ averages.spg|round(1) }}</div>
                    <div class="stat-card-label">Steals</div>
                </div>
                <div class="stat-card" style="min-height: 75px;">
                    <div class="stat-card-value">{{ averages.bpg|round(1) }}</div>
                    <div class="stat-card-label">Blocks</div>
                </div>
                <div class="stat-card" style="min-height: 75px;">
                    <div class="stat-card-value">{{ averages.drebpg|round(1) }}</div>
                    <div class="stat-card-label">Def Rebs</div>
                </div>
                <div class="stat-card" style="min-height: 75px;">
                    <div class="stat-card-value">{{ averages.pfpg|round(1) }}</div>
                    <div class="stat-card-label">Fouls</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Log -->
    <div class="section-title">
        <i class="fas fa-list" style="color: #20c997;"></i>
        Game Log
    </div>

    <div style="overflow-x: auto;">
        <table class="game-log-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Opponent</th>
                    <th>Result</th>
                    <th>MIN</th>
                    <th>PTS</th>
                    <th>REB</th>
                    <th>AST</th>
                    <th>STL</th>
                    <th>BLK</th>
                    <th>FG</th>
                    <th>3PT</th>
                    <th>FT</th>
                    <th>TOV</th>
                    <th>EFF</th>
                    <th>ORtg</th>
                    <th>GmSc</th>
                </tr>
            </thead>
            <tbody>
                {% for log in game_logs %}
                <tr>
                    <td><a href="{{ url_for('main.game_detail', game_id=log.game.id) }}" style="text-decoration: none; color: #667eea; font-weight: 600;">{{ log.game.date }}</a></td>
                    <td><strong>{{ log.game.opponent }}</strong></td>
                    <td>
                        <span class="result-badge result-{{ log.game.result|lower }}">
                            {{ log.game.result }} {{ log.game.team_score }}-{{ log.game.opponent_score }}
                        </span>
                    </td>
                    <td>{{ log.stat.minutes }}</td>
                    <td><strong>{{ log.stat.points }}</strong></td>
                    <td>{{ log.stat.reb }}</td>
                    <td>{{ log.stat.ast }}</td>
                    <td>{{ log.stat.stl }}</td>
                    <td>{{ log.stat.blk }}</td>
                    <td>{{ log.stat.fgm }}-{{ log.stat.fga }}</td>
                    <td>{{ log.stat.tpm }}-{{ log.stat.tpa }}</td>
                    <td>{{ log.stat.ftm }}-{{ log.stat.fta }}</td>
                    <td>{{ log.stat.tov }}</td>
                    <td>{{ log.eff|round(1) }}</td>
                    <td>{{ log.ortg|round(0) }}</td>
                    <td>{{ (log.stat.points + 0.4 * log.stat.fgm - 0.7 * log.stat.fga - 0.4*(log.stat.fta - log.stat.ftm) + 0.7 * log.stat.oreb + 0.3 * log.stat.dreb + log.stat.stl + 0.7 * log.stat.ast + 0.7 * log.stat.blk - 0.4 * log.stat.pf - log.stat.tov)|round(1) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="shot-tooltip" class="shot-tooltip"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartData = {{ chart_data|tojson }};

    let scoringChart, shootingChart;

    function buildCharts() {
        const scoringEl = document.getElementById('scoringChart');
        const shootingEl = document.getElementById('shootingChart');

        if (!scoringEl || !shootingEl) return;

        if (scoringChart) scoringChart.destroy();
        if (shootingChart) shootingChart.destroy();

        scoringChart = new Chart(scoringEl, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Points',
                    data: chartData.points,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { backgroundColor: 'rgba(0,0,0,0.8)' }
                },
                scales: { y: { beginAtZero: true } }
            }
        });

        shootingChart = new Chart(shootingEl, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'FG%',
                        data: chartData.fg_pct,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '3PT%',
                        data: chartData.tp_pct,
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { tooltip: { backgroundColor: 'rgba(0,0,0,0.8)' } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });

        /* Render Shot Chart */
        {% if shot_events %}
        const shots = [
            {% for s in shot_events %}
            {
                game: "{{ s.game.opponent }}",
                x: {{ s.x_loc }},
                y: {{ s.y_loc }},
                result: "{{ s.result }}",
                type: "{{ s.shot_type }}",
                points: {{ s.points }}
            },
            {% endfor %}
        ];

        const shotLayer = document.getElementById('shotLayer');
        const shotTooltip = document.getElementById('shot-tooltip');

        if (shotLayer) {
            shots.forEach(shot => {
                if (shot.x === null || shot.y === null) return;
                
                const dot = document.createElement('div');
                dot.classList.add('shot-point');
                dot.classList.add(shot.result === 'made' ? 'shot-made' : 'shot-missed');
                
                dot.style.left = shot.x + '%';
                dot.style.top = shot.y + '%';
                
                dot.addEventListener('mouseenter', (e) => {
                    shotTooltip.innerHTML = `<strong>vs ${shot.game}</strong><br>${shot.type} (${shot.points} pts)<br>${shot.result.toUpperCase()}`;
                    shotTooltip.style.display = 'block';
                    shotTooltip.style.left = e.pageX + 10 + 'px';
                    shotTooltip.style.top = e.pageY + 10 + 'px';
                });
                
                dot.addEventListener('mouseleave', () => {
                    shotTooltip.style.display = 'none';
                });

                shotLayer.appendChild(dot);
            });
        }
        {% endif %}

        const loader = document.getElementById('pageLoader');
        const page = document.getElementById('playerPage');
        if (page) page.classList.remove('page-hidden');
        if (loader) {
            loader.classList.add('hidden');
            setTimeout(() => loader.remove(), 250);
        }
    }

    window.addEventListener('load', () => {
        requestAnimationFrame(() => requestAnimationFrame(buildCharts));
    });
</script>
{% endblock %}
