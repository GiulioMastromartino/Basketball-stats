{% extends "base.html" %}

{% block content %}
<style>
    /* Tooltip styling */
    .header-content {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        cursor: help;
    }

    .stat-tooltip {
        visibility: hidden;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a202c;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
        margin-bottom: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        font-weight: 500;
        text-transform: none;
        line-height: 1.4;
    }

    .stat-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1a202c transparent transparent transparent;
    }

    .header-content:hover .stat-tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* Table styling to match original aesthetics */
    .table th {
        vertical-align: middle;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 12px 10px;
        white-space: nowrap;
    }

    .sort-link {
        color: inherit;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .sort-icon {
        font-size: 10px;
        margin-left: 4px;
        opacity: 0.3;
    }

    .active-sort {
        opacity: 1;
        color: #3182ce;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Players Table</h1>
            <p class="text-muted">{{ stats|length }} active players</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.players', view='cards', game_type=filters.type) }}" class="btn btn-outline-primary">
                <i class="fas fa-th"></i> Card View
            </a>
            <a href="#" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Player
            </a>
        </div>
    </div>

    <!-- Controls / Filter Bar -->
    <div class="card mb-4">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
                <!-- Search -->
                <div style="flex: 1; min-width: 250px; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    <input type="text" placeholder="Search players..." style="padding-left: 36px; width: 100%; border-radius: var(--border-radius);" onkeyup="searchTable(this.value)">
                </div>

                <!-- Filters -->
                <div class="d-flex gap-2">
                    <select class="form-select" style="width: auto;" id="gameTypeFilter" onchange="window.location.href='{{ url_for('main.players', view='table') }}&game_type=' + this.value">
                        <option value="ALL" {% if filters.type == 'ALL' %}selected{% endif %}>All Games</option>
                        <option value="Season" {% if filters.type == 'Season' %}selected{% endif %}>Season</option>
                        <option value="Friendly" {% if filters.type == 'Friendly' %}selected{% endif %}>Friendly</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="playersTable">
                <thead class="table-light">
                    <tr>
                        {% set current_sort = filters.sort %}
                        {% set current_order = filters.order %}
                        {% set next_order = 'asc' if current_order == 'desc' else 'desc' %}

                        <!-- Player Name Column -->
                        <th style="min-width: 200px; padding-left: 20px;">
                            <a href="{{ url_for('main.players', view='table', game_type=filters.type, sort='player_name', order=next_order) }}" class="sort-link justify-content-start">
                                PLAYER
                                {% if current_sort == 'player_name' %}
                                    <i class="fas fa-sort-{{ 'down' if current_order == 'desc' else 'up' }} sort-icon active-sort"></i>
                                {% else %}
                                    <i class="fas fa-sort sort-icon"></i>
                                {% endif %}
                            </a>
                        </th>
                        
                        <!-- Stats Columns -->
                        {% for col in [
                            ('games_played', 'GP', 'Games Played'),
                            ('mpg', 'MPG', 'Minutes Per Game'),
                            ('ppg', 'PPG', 'Points Per Game'),
                            ('rpg', 'RPG', 'Rebounds Per Game'),
                            ('apg', 'APG', 'Assists Per Game'),
                            ('spg', 'SPG', 'Steals Per Game'),
                            ('bpg', 'BPG', 'Blocks Per Game'),
                            ('fg_pct', 'FG%', 'Field Goal Percentage'),
                            ('tp_pct', '3P%', '3-Point Percentage'),
                            ('ft_pct', 'FT%', 'Free Throw Percentage'),
                            ('eff', 'EFF', 'Efficiency Rating'),
                            ('ppp', 'PPP', 'Points Per Possession'),
                            ('ortg', 'ORtg', 'Offensive Rating')
                        ] %}
                        <th class="text-center {% if col[1] in ['PPG', 'EFF'] %}bg-light border-start border-end{% endif %}">
                            <a href="{{ url_for('main.players', view='table', game_type=filters.type, sort=col[0], order=next_order) }}" class="sort-link">
                                <div class="header-content">
                                    {{ col[1] }}
                                    <span class="stat-tooltip">{{ col[2] }}</span>
                                </div>
                                {% if current_sort == col[0] %}
                                    <i class="fas fa-sort-{{ 'down' if current_order == 'desc' else 'up' }} sort-icon active-sort"></i>
                                {% else %}
                                    <i class="fas fa-sort sort-icon"></i>
                                {% endif %}
                            </a>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for p in stats %}
                    <tr>
                        <td style="padding-left: 20px;">
                            <a href="{{ url_for('main.player_detail', player_name=p.player_name, game_type=filters.type) }}" class="d-flex align-items-center text-decoration-none text-dark fw-bold">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-size: 14px; border: 1px solid #dee2e6; color: #667eea; font-weight: 700;">
                                    {{ p.player_name[:2]|upper }}
                                </div>
                                <div>
                                    <div style="line-height: 1;">{{ p.player_name }}</div>
                                    <small class="text-muted" style="font-weight: 400; font-size: 11px;">{{ p.games_played }} Games</small>
                                </div>
                            </a>
                        </td>
                        <td class="text-center">{{ p.games_played }}</td>
                        <td class="text-center">{{ p.mpg|round(1) }}</td>
                        <td class="text-center bg-light border-start border-end fw-bold" style="color: #2d3748;">{{ p.ppg|round(1) }}</td>
                        <td class="text-center">{{ p.rpg|round(1) }}</td>
                        <td class="text-center">{{ p.apg|round(1) }}</td>
                        <td class="text-center">{{ p.spg|round(1) }}</td>
                        <td class="text-center">{{ p.bpg|round(1) }}</td>
                        <td class="text-center border-start">{{ (p.fg_pct * 100)|round(1) }}%</td>
                        <td class="text-center">{{ (p.tp_pct * 100)|round(1) }}%</td>
                        <td class="text-center">{{ (p.ft_pct * 100)|round(1) }}%</td>
                        <td class="text-center border-start fw-bold" style="color: #2d3748;">{{ p.eff|round(1) }}</td>
                        <td class="text-center">{{ p.ppp|round(2) }}</td>
                        <td class="text-center">{{ p.ortg|round(0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function searchTable(query) {
        const rows = document.querySelectorAll('#playersTable tbody tr');
        const lowerQuery = query.toLowerCase();
        
        rows.forEach(row => {
            const nameCell = row.cells[0].textContent.trim().toLowerCase();
            if (nameCell.includes(lowerQuery)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}