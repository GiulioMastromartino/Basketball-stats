{% extends "base.html" %}

{% block content %}
<style>
    .data-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-top: 20px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .data-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .data-table th {
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
        white-space: nowrap;
        border-right: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        position: relative;
    }
    
    .data-table th:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .data-table td {
        padding: 12px 10px;
        text-align: center;
        border-bottom: 1px solid #eee;
        color: #333;
    }
    
    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .player-link {
        color: #667eea;
        font-weight: 600;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-start; /* Align name to left */
    }
    
    .player-link:hover {
        text-decoration: underline;
    }
    
    .avatar-sm {
        width: 32px;
        height: 32px;
        background: #f0f2f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: #666;
    }
    
    /* Sticky first column for names */
    .data-table td:first-child, 
    .data-table th:first-child {
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 2;
        text-align: left;
    }
    
    .data-table th:first-child {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 3;
    }

    /* Tooltip Styles */
    .stat-header {
        position: relative;
        display: inline-block;
    }

    .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%; /* Position above */
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        font-weight: normal;
        pointer-events: none;
        white-space: normal;
    }

    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }

    .stat-header:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    .formula {
        display: block;
        margin-top: 4px;
        color: #aebbf0;
        font-family: monospace;
        font-size: 11px;
    }

    /* Glossary Section */
    .glossary-section {
        margin-top: 40px;
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .glossary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .glossary-item {
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 3px solid #667eea;
    }

    .glossary-term {
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    .glossary-def {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
    }

    .glossary-formula-box {
        margin-top: 8px;
        padding: 6px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        color: #555;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Player Statistics</h1>
            <p class="text-muted">Comprehensive data view for {{ stats|length }} players</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.players', view='cards', game_type=filters.type) }}" class="btn btn-outline-primary">
                <i class="fas fa-th-large"></i> Card View
            </a>
            <select class="form-select" style="width: auto;" onchange="window.location.href='{{ url_for('main.players', view='table') }}&game_type=' + this.value">
                <option value="ALL" {% if filters.type == 'ALL' %}selected{% endif %}>All Games</option>
                <option value="Season" {% if filters.type == 'Season' %}selected{% endif %}>Season</option>
                <option value="Friendly" {% if filters.type == 'Friendly' %}selected{% endif %}>Friendly</option>
            </select>
        </div>
    </div>

    <div class="data-table-container">
        <div style="overflow-x: auto;">
            <table class="data-table" id="statsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Player</th>
                        <th onclick="sortTable(1)">GP</th>
                        <th onclick="sortTable(2)">MPG</th>
                        <th onclick="sortTable(3)">PPG</th>
                        <th onclick="sortTable(4)">RPG</th>
                        <th onclick="sortTable(5)">APG</th>
                        <th onclick="sortTable(6)">SPG</th>
                        <th onclick="sortTable(7)">BPG</th>
                        <th onclick="sortTable(8)">TOPG</th>
                        <th onclick="sortTable(9)">FG%</th>
                        <th onclick="sortTable(10)">3P%</th>
                        <th onclick="sortTable(11)">FT%</th>
                        <th onclick="sortTable(12)">
                            <div class="stat-header">
                                EFF
                                <span class="tooltip-text">
                                    Efficiency Rating
                                    <span class="formula">(PTS + REB + AST + STL + BLK) - ((FGA - FGM) + (FTA - FTM) + TO)</span>
                                </span>
                            </div>
                        </th>
                        <th onclick="sortTable(13)">
                            <div class="stat-header">
                                ORtg
                                <span class="tooltip-text">
                                    Offensive Rating: Points produced per 100 possessions
                                    <span class="formula">(Points Prod / Poss) * 100</span>
                                </span>
                            </div>
                        </th>
                        <th onclick="sortTable(14)">
                            <div class="stat-header">
                                TS%
                                <span class="tooltip-text">
                                    True Shooting Percentage
                                    <span class="formula">PTS / (2 * (FGA + 0.44 * FTA))</span>
                                </span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in stats %}
                    <tr>
                        <td style="background: white;">
                            <a href="{{ url_for('main.player_detail', player_name=p.player_name, game_type=filters.type) }}" class="player-link">
                                <div class="avatar-sm">{{ p.player_name[:2]|upper }}</div>
                                {{ p.player_name }}
                            </a>
                        </td>
                        <td>{{ p.games_played }}</td>
                        <td>{{ p.mpg|round(1) }}</td>
                        <td><strong>{{ p.ppg|round(1) }}</strong></td>
                        <td>{{ p.rpg|round(1) }}</td>
                        <td>{{ p.apg|round(1) }}</td>
                        <td>{{ p.spg|round(1) }}</td>
                        <td>{{ p.bpg|round(1) }}</td>
                        <td>{{ p.topg|round(1) }}</td>
                        <td>{{ p.fg_pct|round(1) }}%</td>
                        <td>{{ p.tp_pct|round(1) }}%</td>
                        <td>{{ p.ft_pct|round(1) }}%</td>
                        <td><strong>{{ p.eff|round(1) }}</strong></td>
                        <td>{{ p.ortg|round(0) }}</td>
                        <td>{{ p.ts_pct|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Glossary Section -->
    <div class="glossary-section">
        <h3><i class="fas fa-book"></i> Statistics Glossary</h3>
        <p class="text-muted mb-0">Definitions and formulas for advanced metrics used in the table above.</p>
        
        <div class="glossary-grid">
            <div class="glossary-item">
                <div class="glossary-term">EFF <span>Efficiency</span></div>
                <div class="glossary-def">Standard NBA composite efficiency rating derived from basic box score statistics.</div>
                <div class="glossary-formula-box">(PTS + REB + AST + STL + BLK) - ((FGA - FGM) + (FTA - FTM) + TO)</div>
            </div>

            <div class="glossary-item">
                <div class="glossary-term">ORtg <span>Offensive Rating</span></div>
                <div class="glossary-def">Estimate of points produced (scored or assisted) per 100 possessions. Independent of pace.</div>
                <div class="glossary-formula-box">(Points Produced / Possessions) * 100</div>
            </div>

            <div class="glossary-item">
                <div class="glossary-term">TS% <span>True Shooting %</span></div>
                <div class="glossary-def">Shooting efficiency that accounts for field goals, 3-pointers, and free throws.</div>
                <div class="glossary-formula-box">PTS / (2 * (FGA + 0.44 * FTA))</div>
            </div>

            <div class="glossary-item">
                <div class="glossary-term">eFG% <span>Effective FG %</span></div>
                <div class="glossary-def">Adjusts field goal percentage to account for the fact that 3-point shots are worth more.</div>
                <div class="glossary-formula-box">(FGM + 0.5 * 3PM) / FGA</div>
            </div>

            <div class="glossary-item">
                <div class="glossary-term">Usage %</div>
                <div class="glossary-def">Estimate of the percentage of team plays used by a player while they were on the floor.</div>
                <div class="glossary-formula-box">(Player Poss / Team Poss) * 100</div>
            </div>

            <div class="glossary-item">
                <div class="glossary-term">Possessions</div>
                <div class="glossary-def">Estimated number of possessions based on box score data.</div>
                <div class="glossary-formula-box">FGA + 0.44 * FTA + TOV - OREB</div>
            </div>
        </div>
    </div>
</div>

<script>
function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("statsTable");
  switching = true;
  dir = "desc"; // Default desc for stats
  
  // If sorting by name (column 0), default to asc
  if (n === 0) dir = "asc";

  while (switching) {
    switching = false;
    rows = table.rows;
    
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      
      // Handle the complex header structure for advanced stats
      // We need to compare the text content of the TD, which corresponds to the TH index
      
      let xVal = x.innerText.replace('%', '').trim();
      let yVal = y.innerText.replace('%', '').trim();
      
      let xNum = parseFloat(xVal);
      let yNum = parseFloat(yVal);
      
      // Check if numeric
      if (!isNaN(xNum) && !isNaN(yNum)) {
          if (dir == "asc") {
            if (xNum > yNum) { shouldSwitch = true; break; }
          } else if (dir == "desc") {
            if (xNum < yNum) { shouldSwitch = true; break; }
          }
      } else {
          // String comparison
          if (dir == "asc") {
            if (xVal.toLowerCase() > yVal.toLowerCase()) { shouldSwitch = true; break; }
          } else if (dir == "desc") {
            if (xVal.toLowerCase() < yVal.toLowerCase()) { shouldSwitch = true; break; }
          }
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount ++;
    } else {
      if (switchcount == 0 && dir == "desc") {
        dir = "asc";
        switching = true;
      }
    }
  }
}
</script>
{% endblock %}