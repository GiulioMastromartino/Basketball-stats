<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Analytics Suite - Basketball Stats</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/analytics.css') }}"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            /* Progress Modal Styles */
            .progress-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                align-items: center;
                justify-content: center;
            }
            
            .progress-modal.active {
                display: flex;
            }
            
            .progress-content {
                background: white;
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
                text-align: center;
            }
            
            .progress-icon {
                font-size: 64px;
                margin-bottom: 20px;
                animation: spin 2s linear infinite;
            }
            
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            .progress-title {
                font-size: 24px;
                font-weight: 700;
                color: #333;
                margin-bottom: 12px;
            }
            
            .progress-description {
                color: #666;
                margin-bottom: 30px;
                font-size: 14px;
            }
            
            .progress-bar-container {
                width: 100%;
                height: 20px;
                background: #e9ecef;
                border-radius: 10px;
                overflow: hidden;
                margin-bottom: 15px;
                position: relative;
            }
            
            .progress-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
                width: 0%;
                transition: width 0.5s ease;
                position: relative;
            }
            
            .progress-bar-fill::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent
                );
                animation: shimmer 2s infinite;
            }
            
            @keyframes shimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
            
            .progress-text {
                color: #333;
                font-weight: 600;
                font-size: 14px;
            }
            
            .progress-stage {
                color: #999;
                font-size: 12px;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <!-- Progress Modal -->
        <div id="progressModal" class="progress-modal">
            <div class="progress-content">
                <div class="progress-icon">
                    <i class="fas fa-file-pdf" style="color: #f5576c;"></i>
                </div>
                <div class="progress-title">Generating Reports</div>
                <div class="progress-description">
                    Creating PDF reports for all players. This may take a moment...
                </div>
                <div class="progress-bar-container">
                    <div id="progressBarFill" class="progress-bar-fill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
                <div class="progress-stage" id="progressStage">Initializing...</div>
            </div>
        </div>

        <div class="header">
            <h1>
                <i class="fas fa-chart-pie" style="color: #4dabf7"></i>
                Analytics Suite
            </h1>
            <div style="display: flex; gap: 15px; align-items: center">
                <!-- Team PDF Report Button -->
                <button 
                    onclick="window.location.href='/team/report.pdf?game_type=ALL'" 
                    style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                >
                    <i class="fas fa-users"></i> Team Report
                </button>
                
                <!-- Download All Button with Progress -->
                <button 
                    id="downloadAllBtn"
                    onclick="downloadAllReports()" 
                    style="
                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                >
                    <i class="fas fa-download"></i> Download All
                </button>
                
                <a href="{{ url_for('main.index') }}">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>

        <div class="container">
            <!-- NAVIGATION TABS -->
            <div class="tabs-container">
                <div class="tab active" onclick="switchTab('team')">
                    <i class="fas fa-users"></i> Team Overview
                </div>
                <div class="tab" onclick="switchTab('multi')">
                    <i class="fas fa-user-astronaut"></i> Player Comparison
                </div>
                <div class="tab" onclick="switchTab('consistency')">
                    <i class="fas fa-chart-line"></i> Consistency
                </div>
                <div class="tab" onclick="switchTab('roles')">
                    <i class="fas fa-user-tag"></i> Player Roles
                </div>
            </div>

            <!-- TEAM OVERVIEW SECTION -->
            <div id="team" class="section active">
                <div class="panel">
                    <div class="panel-header">
                        <h3>
                            <i class="fas fa-trophy" style="color: #ffc107"></i>
                            Top Performers
                        </h3>
                        <div
                            class="control-bar"
                            style="
                                background: transparent;
                                border: none;
                                padding: 0;
                            "
                        >
                            <div>
                                <label>Metric:</label>
                                <select
                                    id="topStat"
                                    onchange="updateTeamCharts()"
                                >
                                    <option value="efficiency" selected>
                                        Efficiency (EFF)
                                    </option>
                                    <option value="points">Points</option>
                                    <option value="rebounds">Rebounds</option>
                                    <option value="assists">Assists</option>
                                    <option value="steals">Steals</option>
                                    <option value="blocks">Blocks</option>
                                    <option value="ts_pct">
                                        True Shooting %
                                    </option>
                                    <option value="efg_pct">
                                        Effective FG %
                                    </option>
                                    <option value="fg_pct">FG%</option>
                                    <option value="3p_pct">3P%</option>
                                    <option value="ft_pct">FT%</option>
                                </select>
                            </div>
                            <div>
                                <label>Period:</label>
                                <select
                                    id="topLimit"
                                    onchange="updateTeamCharts()"
                                >
                                    <option value="3" selected>
                                        Last 3 Games
                                    </option>
                                    <option value="5">Last 5 Games</option>
                                    <option value="10">Last 10 Games</option>
                                    <option value="0">All Season</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div style="height: 300px; position: relative">
                        <canvas id="topChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h3>
                            <i
                                class="fas fa-chart-line"
                                style="color: #20c997"
                            ></i>
                            Team Trends
                        </h3>
                        <div
                            class="control-bar"
                            style="
                                background: transparent;
                                border: none;
                                padding: 0;
                            "
                        >
                            <select id="gameType" onchange="updateTeamCharts()">
                                <option value="ALL">All Match Types</option>
                                <option value="Season">Season Only</option>
                                <option value="Friendly">Friendly Only</option>
                            </select>
                            <select
                                id="trendLimit"
                                onchange="updateTeamCharts()"
                            >
                                <option value="0">Full History</option>
                                <option value="5">Last 5 Games</option>
                                <option value="10">Last 10 Games</option>
                            </select>
                        </div>
                    </div>

                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="label">Win Percentage</div>
                            <div class="value" id="t_win">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Points Per Game</div>
                            <div class="value" id="t_ppg">-</div>
                        </div>
                    </div>

                    <div style="height: 350px; position: relative">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- MULTI-PLAYER ANALYSIS SECTION -->
            <div id="multi" class="section">
                <div class="panel">
                    <div
                        class="panel-header"
                        style="border: none; margin-bottom: 10px"
                    >
                        <h3><i class="fas fa-sliders-h"></i> Configuration</h3>
                        <div
                            style="
                                display: flex;
                                gap: 15px;
                                align-items: center;
                            "
                        >
                            <select
                                id="multiGameType"
                                onchange="updateMultiChart()"
                            >
                                <option value="ALL">All Games</option>
                                <option value="Season">Season Only</option>
                                <option value="Friendly">Friendly Only</option>
                            </select>
                            <label
                                class="checkbox-item"
                                style="
                                    background: #e7f5ff;
                                    color: #007bff;
                                    font-weight: bold;
                                    border: 1px solid #d0ebff;
                                "
                            >
                                <input
                                    type="checkbox"
                                    id="showMA"
                                    onchange="updateMultiChart()"
                                />
                                Show 3-Game Avg
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 20px; flex-wrap: wrap">
                        <div
                            style="flex: 1; min-width: 250px"
                            class="checkbox-wrapper"
                        >
                            <h4>
                                <i class="fas fa-user-plus"></i> Select Players
                            </h4>
                            <div class="checkbox-grid">
                                {% for p in players %}
                                <label class="checkbox-item">
                                    <input
                                        type="checkbox"
                                        class="p-select"
                                        value="{{ p }}"
                                        onchange="updateMultiChart()"
                                    />
                                    {{ p }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div
                            style="flex: 2; min-width: 350px"
                            class="checkbox-wrapper"
                        >
                            <h4>
                                <i class="fas fa-chart-bar"></i> Select Metrics
                            </h4>
                            <div
                                class="checkbox-grid"
                                style="
                                    grid-template-columns: repeat(
                                        auto-fill,
                                        minmax(160px, 1fr)
                                    );
                                "
                            >
                                <!-- Core Stats -->
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="points"
                                        checked
                                        onchange="updateMultiChart()"
                                    />
                                    Points</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="efficiency"
                                        checked
                                        onchange="updateMultiChart()"
                                    />
                                    Efficiency</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="ortg"
                                        onchange="updateMultiChart()"
                                    />
                                    ORtg</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="ppp"
                                        onchange="updateMultiChart()"
                                    />
                                    PPP</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="rebounds"
                                        onchange="updateMultiChart()"
                                    />
                                    Rebounds</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="oreb"
                                        onchange="updateMultiChart()"
                                    />
                                    OREB</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="dreb"
                                        onchange="updateMultiChart()"
                                    />
                                    DREB</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="assists"
                                        onchange="updateMultiChart()"
                                    />
                                    Assists</label
                                >

                                <!-- Advanced Stats -->
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="ts_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    True Shooting %</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="efg_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    Effective FG %</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="fg_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    FG%</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="2pt_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    2PT%</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="3p_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    3PT%</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="ast_tov"
                                        onchange="updateMultiChart()"
                                    />
                                    AST/TOV</label
                                >

                                <!-- Other Stats -->
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="steals"
                                        onchange="updateMultiChart()"
                                    />
                                    Steals</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="blocks"
                                        onchange="updateMultiChart()"
                                    />
                                    Blocks</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="turnovers"
                                        onchange="updateMultiChart()"
                                    />
                                    Turnovers</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="minutes"
                                        onchange="updateMultiChart()"
                                    />
                                    Minutes</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="fouls"
                                        onchange="updateMultiChart()"
                                    />
                                    Fouls</label
                                >
                                <label class="checkbox-item"
                                    ><input
                                        type="checkbox"
                                        class="s-select"
                                        value="usg_pct"
                                        onchange="updateMultiChart()"
                                    />
                                    Usage</label
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div style="height: 500px; position: relative">
                        <canvas id="multiChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- CONSISTENCY SECTION -->
            <div id="consistency" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h3>
                            <i class="fas fa-balance-scale"></i> Consistency
                            Rankings
                        </h3>
                        <div
                            class="control-bar"
                            style="
                                background: transparent;
                                border: none;
                                padding: 0;
                            "
                        >
                            <select
                                id="consistencyGameType"
                                onchange="loadConsistency()"
                            >
                                <option value="ALL">All Games</option>
                                <option value="Season">Season Only</option>
                                <option value="Friendly">Friendly Only</option>
                            </select>
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-top: 20px;
                        "
                    >
                        <div>
                            <h4 style="margin-bottom: 15px">
                                <i
                                    class="fas fa-check-circle"
                                    style="color: #28a745"
                                ></i>
                                Most Consistent (Reliable)
                            </h4>
                            <div id="consistentList"></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px">
                                <i
                                    class="fas fa-exclamation-triangle"
                                    style="color: #ffc107"
                                ></i>
                                Most Volatile (Unpredictable)
                            </h4>
                            <div id="volatileList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROLES SECTION -->
            <div id="roles" class="section">
                <div class="panel">
                    <div class="panel-header">
                        <h3>
                            <i class="fas fa-users-cog"></i> Player Role
                            Analysis
                        </h3>
                        <div
                            class="control-bar"
                            style="
                                background: transparent;
                                border: none;
                                padding: 0;
                            "
                        >
                            <select id="rolesGameType" onchange="loadRoles()">
                                <option value="ALL">All Games</option>
                                <option value="Season">Season Only</option>
                                <option value="Friendly">Friendly Only</option>
                            </select>
                        </div>
                    </div>

                    <div
                        id="rolesGrid"
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fill,
                                minmax(250px, 1fr)
                            );
                            gap: 15px;
                            margin-top: 20px;
                        "
                    ></div>
                </div>

                <div class="panel" style="margin-top: 20px">
                    <h4 style="margin-bottom: 15px">Role Definitions</h4>
                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fit,
                                minmax(200px, 1fr)
                            );
                            gap: 15px;
                        "
                    >
                        <div
                            style="
                                background: #d4edda;
                                padding: 15px;
                                border-radius: 8px;
                            "
                        >
                            <span class="role-badge role-primary"
                                >Primary Scorer</span
                            >
                            <p style="margin: 10px 0 0; font-size: 0.9rem">
                                High usage (>6 poss/g) + High efficiency (>150
                                ORtg)
                            </p>
                        </div>
                        <div
                            style="
                                background: #d1ecf1;
                                padding: 15px;
                                border-radius: 8px;
                            "
                        >
                            <span class="role-badge role-efficient"
                                >Efficient Role</span
                            >
                            <p style="margin: 10px 0 0; font-size: 0.9rem">
                                Low usage (≤6 poss/g) + High efficiency (>150
                                ORtg)
                            </p>
                        </div>
                        <div
                            style="
                                background: #fff3cd;
                                padding: 15px;
                                border-radius: 8px;
                            "
                        >
                            <span class="role-badge role-volume"
                                >Volume Scorer</span
                            >
                            <p style="margin: 10px 0 0; font-size: 0.9rem">
                                High usage (>6 poss/g) + Low efficiency (≤150
                                ORtg)
                            </p>
                        </div>
                        <div
                            style="
                                background: #f8d7da;
                                padding: 15px;
                                border-radius: 8px;
                            "
                        >
                            <span class="role-badge role-reserve">Reserve</span>
                            <p style="margin: 10px 0 0; font-size: 0.9rem">
                                Low usage (≤6 poss/g) + Low efficiency (≤150
                                ORtg)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Download All Reports with Progress Bar
            async function downloadAllReports() {
                const modal = document.getElementById('progressModal');
                const progressBar = document.getElementById('progressBarFill');
                const progressText = document.getElementById('progressText');
                const progressStage = document.getElementById('progressStage');
                const btn = document.getElementById('downloadAllBtn');
                
                // Show modal
                modal.classList.add('active');
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
                
                // Simulate progress stages
                const stages = [
                    { percent: 10, text: 'Fetching player data...' },
                    { percent: 25, text: 'Calculating statistics...' },
                    { percent: 40, text: 'Generating team averages...' },
                    { percent: 60, text: 'Creating PDF reports...' },
                    { percent: 85, text: 'Compiling ZIP archive...' },
                    { percent: 95, text: 'Finalizing download...' }
                ];
                
                let currentStage = 0;
                
                const progressInterval = setInterval(() => {
                    if (currentStage < stages.length) {
                        const stage = stages[currentStage];
                        progressBar.style.width = stage.percent + '%';
                        progressText.textContent = stage.percent + '%';
                        progressStage.textContent = stage.text;
                        currentStage++;
                    }
                }, 800);
                
                try {
                    // Start the actual download
                    const response = await fetch('/reports/download-all?game_type=ALL');
                    
                    if (!response.ok) {
                        throw new Error('Download failed');
                    }
                    
                    // Complete progress
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    progressStage.textContent = 'Download complete!';
                    
                    // Get the blob
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'all_player_reports_ALL.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        modal.classList.remove('active');
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        
                        // Reset progress
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                        progressStage.textContent = 'Initializing...';
                    }, 1500);
                    
                } catch (error) {
                    clearInterval(progressInterval);
                    console.error('Download error:', error);
                    
                    progressBar.style.width = '100%';
                    progressBar.style.background = '#dc3545';
                    progressText.textContent = 'Error!';
                    progressStage.textContent = 'Download failed. Please try again.';
                    
                    setTimeout(() => {
                        modal.classList.remove('active');
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        progressBar.style.background = 'linear-gradient(90deg, #f093fb 0%, #f5576c 100%)';
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                        progressStage.textContent = 'Initializing...';
                    }, 3000);
                }
            }

            function switchTab(id) {
                document
                    .querySelectorAll(".section")
                    .forEach((s) => s.classList.remove("active"));
                document
                    .querySelectorAll(".tab")
                    .forEach((t) => t.classList.remove("active"));
                document.getElementById(id).classList.add("active");
                event.target.closest(".tab").classList.add("active");

                if (id === "team") updateTeamCharts();
                if (id === "multi") updateMultiChart();
                if (id === "consistency") loadConsistency();
                if (id === "roles") loadRoles();
            }

            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = "#6c757d";
            const colors = [
                "#007bff",
                "#e83e8c",
                "#28a745",
                "#fd7e14",
                "#17a2b8",
                "#6610f2",
                "#20c997",
                "#ffc107",
            ];

            let trendChart, topChart, multiChart;

            async function updateTeamCharts() {
                const type = document.getElementById("gameType").value;
                const trendLimit = document.getElementById("trendLimit").value;
                const topStat = document.getElementById("topStat").value;
                const topLimit = document.getElementById("topLimit").value;

                const url = `/api/analytics/team_overview?game_type=${type}&limit_trend=${trendLimit}&top_stat=${topStat}&top_limit=${topLimit}`;

                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Failed to load data");
                    const data = await res.json();

                    document.getElementById("t_win").textContent =
                        data.metrics.win_pct + "%";
                    document.getElementById("t_ppg").textContent =
                        data.metrics.ppg;

                    if (trendChart) trendChart.destroy();
                    const ctxTrend = document
                        .getElementById("trendChart")
                        .getContext("2d");
                    const gradientTeam = ctxTrend.createLinearGradient(
                        0,
                        0,
                        0,
                        400,
                    );
                    gradientTeam.addColorStop(0, "rgba(0, 123, 255, 0.2)");
                    gradientTeam.addColorStop(1, "rgba(0, 123, 255, 0.0)");

                    trendChart = new Chart(ctxTrend, {
                        type: "line",
                        data: {
                            labels: data.trend.labels,
                            datasets: [
                                {
                                    label: "Team Score",
                                    data: data.trend.team_score,
                                    borderColor: "#007bff",
                                    backgroundColor: gradientTeam,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                },
                                {
                                    label: "Opponent Score",
                                    data: data.trend.opp_score,
                                    borderColor: "#dc3545",
                                    borderDash: [5, 5],
                                    tension: 0.4,
                                    pointRadius: 4,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: "index", intersect: false },
                        },
                    });

                    if (topChart) topChart.destroy();
                    topChart = new Chart(document.getElementById("topChart"), {
                        type: "bar",
                        data: {
                            labels: data.top_chart.labels,
                            datasets: [
                                {
                                    label: data.top_chart.label,
                                    data: data.top_chart.data,
                                    backgroundColor: "#20c997",
                                    borderRadius: 6,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: "y",
                        },
                    });
                } catch (error) {
                    console.error("Error loading team charts:", error);
                }
            }

            async function updateMultiChart() {
                const players = Array.from(
                    document.querySelectorAll(".p-select:checked"),
                ).map((c) => c.value);
                const stats = Array.from(
                    document.querySelectorAll(".s-select:checked"),
                ).map((c) => c.value);
                const ma = document.getElementById("showMA").checked;
                const gameType = document.getElementById("multiGameType").value;

                if (players.length === 0 || stats.length === 0) {
                    if (multiChart) multiChart.destroy();
                    return;
                }

                const params = new URLSearchParams();
                players.forEach((p) => params.append("players", p));
                stats.forEach((s) => params.append("stats", s));
                params.append("ma", ma);
                params.append("game_type", gameType);

                try {
                    const res = await fetch(
                        `/api/analytics/multi_compare?${params.toString()}`,
                    );
                    if (!res.ok) throw new Error("Failed to load data");
                    const data = await res.json();

                    data.datasets.forEach((ds, i) => {
                        const colorIndex =
                            Math.floor(i / (ma ? 2 : 1)) % colors.length;
                        ds.borderColor = colors[colorIndex];
                        ds.backgroundColor = colors[colorIndex];
                    });

                    if (multiChart) multiChart.destroy();
                    multiChart = new Chart(
                        document.getElementById("multiChart"),
                        {
                            type: "line",
                            data: {
                                labels: data.labels,
                                datasets: data.datasets,
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: "index",
                                    intersect: false,
                                },
                                plugins: {
                                    tooltip: {
                                        backgroundColor: "rgba(0,0,0,0.8)",
                                        padding: 12,
                                        cornerRadius: 8,
                                    },
                                    legend: {
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20,
                                        },
                                    },
                                },
                            },
                        },
                    );
                } catch (error) {
                    console.error("Error loading multi chart:", error);
                }
            }

            async function loadConsistency() {
                const gameType = document.getElementById(
                    "consistencyGameType",
                ).value;

                try {
                    const res = await fetch(
                        `/api/analytics/consistency_leaderboard?game_type=${gameType}`,
                    );
                    if (!res.ok) throw new Error("Failed to load data");
                    const data = await res.json();

                    const consistentHtml = data.consistent
                        .map(
                            (p, i) => `
                        <div class="leaderboard-item">
                            <span><strong>${i + 1}. ${p.player}</strong> (${p.ppg} PPG, ${p.games} GP)</span>
                            <span style="font-weight: 600;">CV: ${(p.cv * 100).toFixed(1)}%</span>
                        </div>
                    `,
                        )
                        .join("");

                    const volatileHtml = data.volatile
                        .map(
                            (p, i) => `
                        <div class="leaderboard-item">
                            <span><strong>${i + 1}. ${p.player}</strong> (${p.ppg} PPG, ${p.games} GP)</span>
                            <span style="font-weight: 600;">CV: ${(p.cv * 100).toFixed(1)}%</span>
                        </div>
                    `,
                        )
                        .join("");

                    document.getElementById("consistentList").innerHTML =
                        consistentHtml ||
                        '<p style="text-align: center; color: #999;">No data</p>';
                    document.getElementById("volatileList").innerHTML =
                        volatileHtml ||
                        '<p style="text-align: center; color: #999;">No data</p>';
                } catch (error) {
                    console.error("Error loading consistency:", error);
                }
            }

            async function loadRoles() {
                const gameType = document.getElementById("rolesGameType").value;

                try {
                    const res = await fetch(
                        `/api/analytics/role_analysis?game_type=${gameType}`,
                    );
                    if (!res.ok) throw new Error("Failed to load data");
                    const data = await res.json();

                    const rolesHtml = data.players
                        .map((p) => {
                            let roleClass = "role-reserve";
                            if (p.role === "Primary Scorer")
                                roleClass = "role-primary";
                            else if (p.role === "Efficient Role")
                                roleClass = "role-efficient";
                            else if (p.role === "Volume Scorer")
                                roleClass = "role-volume";

                            return `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 12px;">${p.player}</h4>
                                <span class="role-badge ${roleClass}">${p.role}</span>
                                <div style="margin-top: 16px; font-size: 0.95rem; line-height: 1.8;">
                                    <div><strong>PPG:</strong> ${p.ppg}</div>
                                    <div><strong>Usage:</strong> ${p.usg} poss/g</div>
                                    <div><strong>ORtg:</strong> ${p.ortg}</div>
                                </div>
                            </div>
                        `;
                        })
                        .join("");

                    document.getElementById("rolesGrid").innerHTML =
                        rolesHtml ||
                        '<p style="text-align: center; color: #999;">No data</p>';
                } catch (error) {
                    console.error("Error loading roles:", error);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                updateTeamCharts();
            });
        </script>
    </body>
</html>