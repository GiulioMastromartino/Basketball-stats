{% extends "layout.html" %}

{% block title %}Live Game Tracker{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <!-- CSRF Token for Fetch Requests -->
    <input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

    <!-- STEP 1: GAME SETUP -->
    <div id="setup-panel" class="card p-4">
        <h3>Start New Game</h3>
        <div class="row mb-3">
            <div class="col-md-4">
                <label>Date</label>
                <input type="date" id="game-date" class="form-control" value="{{ now_date }}">
            </div>
            <div class="col-md-4">
                <label>Opponent</label>
                <input type="text" id="opponent" class="form-control" placeholder="e.g. Lakers">
            </div>
            <div class="col-md-4">
                <label>Type</label>
                <select id="game-type" class="form-control">
                    <option value="Season">Season</option>
                    <option value="Friendly">Friendly</option>
                    <option value="Playoff">Playoff</option>
                </select>
            </div>
        </div>
        
        <div class="mb-3">
            <label>Select Full Roster (At least 5 players)</label>
            <div id="roster-selection" class="d-flex flex-wrap gap-2">
                {% for player in existing_players %}
                <button class="btn btn-outline-secondary btn-sm player-select-btn" style="margin: 2px;" onclick="toggleRosterPlayer('{{ player }}', this)">
                    {{ player }}
                </button>
                {% endfor %}
            </div>
            <div class="input-group mt-2" style="width: 300px;">
                <input type="text" id="new-player-name" class="form-control form-control-sm" placeholder="Add New Player...">
                <div class="input-group-append">
                    <button class="btn btn-primary btn-sm" onclick="addNewPlayer()">+</button>
                </div>
            </div>
        </div>

        <button class="btn btn-success w-100" onclick="goToLineupSelection()">Next: Select Starters</button>
    </div>

    <!-- STEP 2: LINEUP SELECTION (Hidden by default) -->
    <div id="lineup-panel" class="card p-4" style="display:none;">
        <h3>Select 5 Starters</h3>
        <p class="text-muted">Select exactly 5 players to start the game.</p>
        
        <div id="starter-selection" class="d-flex flex-wrap gap-2 mb-3">
            <!-- Populated by JS -->
        </div>

        <button class="btn btn-primary w-100" onclick="startGame()">Start Game</button>
    </div>

    <!-- STEP 3: LIVE TRACKER (Hidden by default) -->
    <div id="tracker-panel" style="display:none;">
        
        <!-- Game Info Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-dark text-white rounded shadow-sm">
            
            <!-- Scoreboard -->
            <div class="text-center" style="min-width: 200px;">
                <h2 class="m-0 font-weight-bold" id="scoreboard" style="font-size: 3rem;">0 - 0</h2>
                <small id="display-opponent" class="text-white-50">vs Opponent</small>
            </div>

            <!-- Game Clock & Quarter (CENTERED & LARGE) -->
            <div class="text-center mx-4 flex-grow-1">
                 <!-- Quarter Display -->
                 <div class="mb-1">
                     <span class="badge badge-light" id="quarter-display" style="font-size: 1.2rem;">Q1</span>
                     <button class="btn btn-outline-light btn-sm py-0 px-2 ml-2" onclick="nextQuarter()" title="Next Quarter" style="font-size: 0.8rem;">Next Q &raquo;</button>
                 </div>
                 
                 <!-- Large Clock -->
                 <div class="h1 mb-2 font-weight-bold font-monospace bg-black rounded p-2 d-inline-block border border-secondary" id="game-clock" style="font-size: 4rem; min-width: 280px; letter-spacing: 2px;">00:00</div>
                 
                 <!-- Big Control Button -->
                 <div>
                     <button class="btn btn-success btn-lg px-5 font-weight-bold" id="btn-start-clock" onclick="toggleClock()" style="font-size: 1.5rem;">START</button>
                 </div>
            </div>

            <!-- Controls (RIGHT SIDE) -->
            <div class="text-right" style="min-width: 250px;">
                 <!-- Opponent Score Controls -->
                 <div class="mb-3 p-2 border border-secondary rounded bg-secondary">
                     <div class="d-flex justify-content-between align-items-center mb-1">
                         <label class="mb-0 text-white small font-weight-bold">Opponent Score:</label>
                         <span id="opp-score-display" class="h4 m-0 font-weight-bold">0</span>
                     </div>
                     <div class="btn-group w-100">
                         <button class="btn btn-sm btn-light font-weight-bold" onclick="updateOppScore(1)">+1</button>
                         <button class="btn btn-sm btn-light font-weight-bold" onclick="updateOppScore(2)">+2</button>
                         <button class="btn btn-sm btn-light font-weight-bold" onclick="updateOppScore(3)">+3</button>
                         <button class="btn btn-sm btn-dark" onclick="updateOppScore(-1)" title="Undo">-1</button>
                     </div>
                 </div>

                 <!-- Game Actions -->
                 <div class="d-flex gap-2">
                     <button class="btn btn-warning flex-fill mr-1" onclick="showSubstitutionModal()">
                        <i class="fas fa-exchange-alt"></i> Subs
                     </button>
                     <button class="btn btn-danger flex-fill ml-1" onclick="finishGame()">Finish</button>
                 </div>
                 
                 <!-- Hidden Reset (Small link) -->
                 <div class="mt-2 text-right">
                     <a href="#" class="text-muted small" onclick="if(confirm('Reset clock to 00:00?')) resetClock(); return false;">Reset Clock</a>
                 </div>
            </div>
        </div>

        <!-- Active Players Grid -->
        <div id="player-grid" class="row">
            <!-- Player Cards Generated via JS will go here -->
        </div>
    </div>
</div>

<!-- Substitution Modal -->
<div class="modal fade" id="subModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Substitutions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Select exactly 5 players to be on the floor.</p>
        <div id="sub-roster-list" class="list-group">
            <!-- Populated by JS -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="confirmSubs()">Confirm Lineup</button>
      </div>
    </div>
  </div>
</div>

<!-- Assist Modal -->
<div class="modal fade" id="assistModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assist</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Who assisted on <span class="font-weight-bold" id="assist-shot-label"></span>?</p>
        <div id="assist-list" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Offensive Rebound Modal -->
<div class="modal fade" id="orebModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Offensive Rebound</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Who got the offensive rebound after <span class="font-weight-bold" id="oreb-shot-label"></span>?</p>
        <div id="oreb-list" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let fullRoster = [];
    let activeLineup = []; 
    let stats = {}; 
    let opponentScore = 0;

    // Pending actions for popups
    let pendingAssist = null; // { shooter, type, points }
    let pendingOreb = null;   // { shooter, type }
    
    // Timer State (Count UP)
    let timerInterval = null;
    let quarter = 1;
    let clockSeconds = 0; // Starts at 0
    let isClockRunning = false;

    // --- SETUP PHASE ---
    function toggleRosterPlayer(name, btn) {
        if (fullRoster.includes(name)) {
            fullRoster = fullRoster.filter(p => p !== name);
            btn.classList.remove('active', 'btn-primary');
            btn.classList.add('btn-outline-secondary');
        } else {
            fullRoster.push(name);
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('active', 'btn-primary');
        }
    }

    function addNewPlayer() {
        const name = document.getElementById('new-player-name').value.trim();
        if (name && !fullRoster.includes(name)) {
            fullRoster.push(name);
            const container = document.getElementById('roster-selection');
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary btn-sm active player-select-btn';
            btn.style.margin = '2px';
            btn.innerText = name;
            btn.onclick = function() { toggleRosterPlayer(name, this); };
            container.appendChild(btn);
            document.getElementById('new-player-name').value = '';
        }
    }

    function goToLineupSelection() {
        if (fullRoster.length < 5) {
            alert("Please select at least 5 players for the roster.");
            return;
        }
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('lineup-panel').style.display = 'block';
        
        const container = document.getElementById('starter-selection');
        container.innerHTML = '';
        fullRoster.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary m-1';
            btn.innerText = p;
            btn.onclick = function() {
                if (activeLineup.includes(p)) {
                    activeLineup = activeLineup.filter(x => x !== p);
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-secondary');
                } else {
                    if (activeLineup.length >= 5) {
                        alert("You can only select 5 starters.");
                        return;
                    }
                    activeLineup.push(p);
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-primary');
                }
            };
            container.appendChild(btn);
        });
    }

    function startGame() {
        if (activeLineup.length !== 5) {
            alert("Please select exactly 5 starters.");
            return;
        }
        const opponent = document.getElementById('opponent').value;
        if (!opponent) {
            alert("Please enter an opponent name.");
            return;
        }

        // Initialize stats
        fullRoster.forEach(p => {
            stats[p] = { 
                points: 0, fgm: 0, fga: 0, tpm: 0, tpa: 0, ftm: 0, fta: 0, 
                oreb: 0, dreb: 0, ast: 0, tov: 0, stl: 0, blk: 0, pf: 0,
                minutes_seconds: 0,
                last_sub_in: activeLineup.includes(p) ? Date.now() : null
            };
        });

        document.getElementById('lineup-panel').style.display = 'none';
        document.getElementById('tracker-panel').style.display = 'block';
        document.getElementById('display-opponent').innerText = "vs " + opponent;

        renderActivePlayers();
    }

    // --- GAMEPLAY PHASE ---

    function renderActivePlayers() {
        const grid = document.getElementById('player-grid');
        grid.innerHTML = '';
        
        activeLineup.forEach(p => {
            const s = stats[p];
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
                            <h5 class="mb-0 text-truncate" style="max-width: 65%; font-weight: bold;">${p}</h5>
                            <div>
                                <span class="badge badge-light mr-1" id="pts-${p}" style="font-size: 0.9em;">${s.points} PTS</span>
                                <span class="badge badge-warning" id="pf-badge-${p}" style="font-size: 0.9em;">${s.pf} PF</span>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            
                            <!-- SHOOTING SECTION -->
                            <div class="mb-2 border-bottom pb-2">
                                <!-- 2PT -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="font-weight-bold small text-muted" style="width: 40px;">2PT</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="updateShooting('${p}', '2pt', -1, -1)">-M</button>
                                        <button class="btn btn-outline-secondary py-0" onclick="updateShooting('${p}', '2pt', 0, -1)">-A</button>
                                    </div>
                                    <span class="mx-2 font-weight-bold" id="disp-2pt-${p}">${(s.fgm - s.tpm)}/${(s.fga - s.tpa)}</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="openOrebModal('${p}', '2pt')">Miss</button>
                                        <button class="btn btn-success font-weight-bold py-0" onclick="openAssistModal('${p}', '2pt', 2)">+2</button>
                                    </div>
                                </div>

                                <!-- 3PT -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="font-weight-bold small text-muted" style="width: 40px;">3PT</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="updateShooting('${p}', '3pt', -1, -1)">-M</button>
                                        <button class="btn btn-outline-secondary py-0" onclick="updateShooting('${p}', '3pt', 0, -1)">-A</button>
                                    </div>
                                    <span class="mx-2 font-weight-bold" id="disp-3pt-${p}">${s.tpm}/${s.tpa}</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="openOrebModal('${p}', '3pt')">Miss</button>
                                        <button class="btn btn-success font-weight-bold py-0" onclick="openAssistModal('${p}', '3pt', 3)">+3</button>
                                    </div>
                                </div>

                                <!-- FT (no assist popup) -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="font-weight-bold small text-muted" style="width: 40px;">FT</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="updateShooting('${p}', 'ft', -1, -1)">-M</button>
                                        <button class="btn btn-outline-secondary py-0" onclick="updateShooting('${p}', 'ft', 0, -1)">-A</button>
                                    </div>
                                    <span class="mx-2 font-weight-bold" id="disp-ft-${p}">${s.ftm}/${s.fta}</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger py-0" onclick="updateShooting('${p}', 'ft', 0, 1)">Miss</button>
                                        <button class="btn btn-success font-weight-bold py-0" onclick="updateShooting('${p}', 'ft', 1, 1)">+1</button>
                                    </div>
                                </div>
                            </div>

                            <!-- OTHER STATS GRID -->
                            <div class="row no-gutters text-center">
                                ${renderStatBox(p, 'OREB', 'oreb', s.oreb)}
                                ${renderStatBox(p, 'DREB', 'dreb', s.dreb)}
                                ${renderStatBox(p, 'AST', 'ast', s.ast)}
                            </div>
                            <div class="row no-gutters text-center mt-1">
                                ${renderStatBox(p, 'STL', 'stl', s.stl)}
                                ${renderStatBox(p, 'BLK', 'blk', s.blk)}
                                ${renderStatBox(p, 'TOV', 'tov', s.tov)}
                            </div>
                            <div class="row no-gutters text-center mt-1">
                                ${renderStatBox(p, 'PF', 'pf', s.pf, 'text-danger')}
                            </div>
                            
                            <div class="mt-2 text-center small text-muted">
                                <span id="time-${p}" class="font-weight-bold">MIN: ${formatMinutes(s.minutes_seconds)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function renderStatBox(player, label, key, value, textClass='') {
        return `
            <div class="col-4 px-1">
                <div class="bg-light rounded p-1 border">
                    <div class="small text-muted font-weight-bold mb-1">${label}</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size: 0.7rem; line-height:1;" onclick="updateStat('${player}', '${key}', -1)">-</button>
                        <span class="h5 m-0 mx-2 font-weight-bold ${textClass}" id="disp-${key}-${player}">${value}</span>
                        <button class="btn btn-sm btn-outline-dark py-0 px-1" style="font-size: 0.8rem; line-height:1;" onclick="updateStat('${player}', '${key}', 1)">+</button>
                    </div>
                </div>
            </div>
        `;
    }

    // --- POPUPS ---

    function openAssistModal(shooter, type, points) {
        pendingAssist = { shooter, type, points };
        document.getElementById('assist-shot-label').innerText = `${shooter} ${points}PT MADE`;

        const list = document.getElementById('assist-list');
        list.innerHTML = '';

        // No assist option
        const noneBtn = document.createElement('button');
        noneBtn.type = 'button';
        noneBtn.className = 'list-group-item list-group-item-action font-weight-bold';
        noneBtn.innerText = 'No assist';
        noneBtn.onclick = () => confirmAssist(null);
        list.appendChild(noneBtn);

        // Assist options (only on-court, excluding shooter)
        activeLineup.forEach(p => {
            if (p === shooter) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.innerText = p;
            btn.onclick = () => confirmAssist(p);
            list.appendChild(btn);
        });

        $('#assistModal').modal('show');
    }

    function confirmAssist(assister) {
        if (!pendingAssist) return;
        const { shooter, type } = pendingAssist;

        // Apply made shot
        updateShooting(shooter, type, 1, 1);

        // Apply assist if selected
        if (assister && stats[assister]) {
            updateStat(assister, 'ast', 1);
        }

        pendingAssist = null;
        $('#assistModal').modal('hide');
    }

    function openOrebModal(shooter, type) {
        pendingOreb = { shooter, type };
        document.getElementById('oreb-shot-label').innerText = `${shooter} ${type.toUpperCase()} MISS`;

        const list = document.getElementById('oreb-list');
        list.innerHTML = '';

        // No oreb option
        const noneBtn = document.createElement('button');
        noneBtn.type = 'button';
        noneBtn.className = 'list-group-item list-group-item-action font-weight-bold';
        noneBtn.innerText = 'No offensive rebound';
        noneBtn.onclick = () => confirmOreb(null);
        list.appendChild(noneBtn);

        // OREB options (only on-court)
        activeLineup.forEach(p => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.innerText = p;
            btn.onclick = () => confirmOreb(p);
            list.appendChild(btn);
        });

        $('#orebModal').modal('show');
    }

    function confirmOreb(rebounder) {
        if (!pendingOreb) return;
        const { shooter, type } = pendingOreb;

        // Apply missed shot attempt
        updateShooting(shooter, type, 0, 1);

        // Apply offensive rebound if selected
        if (rebounder && stats[rebounder]) {
            updateStat(rebounder, 'oreb', 1);
        }

        pendingOreb = null;
        $('#orebModal').modal('hide');
    }

    // --- CORE UPDATERS ---

    function updateShooting(player, type, makeDelta, attemptDelta) {
        if (!stats[player]) return;
        const s = stats[player];

        // Apply changes safely
        if (type === '2pt') {
            const current2M = s.fgm - s.tpm;
            const current2A = s.fga - s.tpa;
            
            if (current2M + makeDelta < 0 || current2A + attemptDelta < 0) return; 
            if (current2A + attemptDelta < current2M + makeDelta) return;

            s.fgm += makeDelta;
            s.fga += attemptDelta;
            s.points += (makeDelta * 2);
        } else if (type === '3pt') {
             if (s.tpm + makeDelta < 0 || s.tpa + attemptDelta < 0) return;
             if (s.tpa + attemptDelta < s.tpm + makeDelta) return;

             s.tpm += makeDelta;
             s.tpa += attemptDelta;
             // Also update FGM/FGA for 3 pointers
             s.fgm += makeDelta;
             s.fga += attemptDelta;
             
             s.points += (makeDelta * 3);
        } else if (type === 'ft') {
             if (s.ftm + makeDelta < 0 || s.fta + attemptDelta < 0) return;
             if (s.fta + attemptDelta < s.ftm + makeDelta) return;

             s.ftm += makeDelta;
             s.fta += attemptDelta;
             s.points += (makeDelta * 1);
        }

        updateUI(player);
    }

    function updateStat(player, key, delta) {
        if (!stats[player]) return;
        if (stats[player][key] + delta < 0) return;

        stats[player][key] += delta;
        updateUI(player);
    }
    
    function updateOppScore(points) {
        opponentScore += points;
        if(opponentScore < 0) opponentScore = 0;
        document.getElementById('opp-score-display').innerText = opponentScore;
        updateScoreboard();
    }

    function updateUI(player) {
         const s = stats[player];
         
         document.getElementById(`pts-${player}`).innerText = s.points + ' PTS';
         document.getElementById(`pf-badge-${player}`).innerText = s.pf + ' PF';
         
         if (document.getElementById(`disp-2pt-${player}`)) {
             const two_m = s.fgm - s.tpm;
             const two_a = s.fga - s.tpa;
             document.getElementById(`disp-2pt-${player}`).innerText = `${two_m}/${two_a}`;
         }
         if (document.getElementById(`disp-3pt-${player}`)) {
             document.getElementById(`disp-3pt-${player}`).innerText = `${s.tpm}/${s.tpa}`;
         }
         if (document.getElementById(`disp-ft-${player}`)) {
             document.getElementById(`disp-ft-${player}`).innerText = `${s.ftm}/${s.fta}`;
         }

         const keys = ['oreb', 'dreb', 'ast', 'stl', 'blk', 'tov', 'pf'];
         keys.forEach(k => {
             const el = document.getElementById(`disp-${k}-${player}`);
             if(el) el.innerText = s[k];
         });

         updateScoreboard();
    }

    function updateScoreboard() {
         let total = 0;
         Object.values(stats).forEach(s => total += s.points);
         document.getElementById('scoreboard').innerText = `${total} - ${opponentScore}`;
    }

    // --- CLOCK & SUBSTITUTIONS --- (Same as before)
    
    function toggleClock() {
        const btn = document.getElementById('btn-start-clock');
        if (isClockRunning) {
            clearInterval(timerInterval);
            isClockRunning = false;
            btn.innerText = "START";
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
            updatePlayerTimes();
        } else {
            const now = Date.now();
            activeLineup.forEach(p => {
                stats[p].last_sub_in = now;
            });
            timerInterval = setInterval(() => {
                clockSeconds++; 
                updateClockDisplay();
            }, 1000);
            isClockRunning = true;
            btn.innerText = "STOP";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
        }
    }

    function updatePlayerTimes() {
        const now = Date.now();
        activeLineup.forEach(p => {
            if (stats[p].last_sub_in) {
                const diffSeconds = Math.floor((now - stats[p].last_sub_in) / 1000);
                stats[p].minutes_seconds += diffSeconds;
                stats[p].last_sub_in = null; 
            }
            const el = document.getElementById(`time-${p}`);
            if (el) el.innerText = 'MIN: ' + formatMinutes(stats[p].minutes_seconds);
        });
    }

    function resetClock() {
        if(isClockRunning) toggleClock();
        clockSeconds = 0; 
        updateClockDisplay();
    }

    function nextQuarter() {
        if(isClockRunning) toggleClock();
        quarter++;
        document.getElementById('quarter-display').innerText = 'Q' + quarter;
        clockSeconds = 0;
        updateClockDisplay();
    }

    function updateClockDisplay() {
        const m = Math.floor(clockSeconds / 60);
        const s = clockSeconds % 60;
        document.getElementById('game-clock').innerText = 
            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Subs Modal Logic
    let tempLineup = [];

    function showSubstitutionModal() {
        if (isClockRunning) toggleClock();
        
        tempLineup = [...activeLineup];
        const container = document.getElementById('sub-roster-list');
        container.innerHTML = '';
        
        fullRoster.forEach(p => {
            const isActive = tempLineup.includes(p);
            const btn = document.createElement('button');
            btn.className = `list-group-item list-group-item-action ${isActive ? 'active' : ''}`;
            btn.style.cursor = 'pointer';
            btn.innerHTML = `<div class="d-flex justify-content-between align-items-center">
                                <span>${p}</span>
                                <small>${isActive ? 'ON COURT' : 'BENCH'}</small>
                             </div>`;
            
            btn.onclick = () => {
                if (tempLineup.includes(p)) {
                    tempLineup = tempLineup.filter(x => x !== p);
                    btn.classList.remove('active');
                    btn.querySelector('small').innerText = 'BENCH';
                } else {
                    if (tempLineup.length >= 5) {
                        alert("Only 5 players allowed on court.");
                        return;
                    }
                    tempLineup.push(p);
                    btn.classList.add('active');
                    btn.querySelector('small').innerText = 'ON COURT';
                }
            };
            container.appendChild(btn);
        });
        
        $('#subModal').modal('show');
    }

    function confirmSubs() {
        if (tempLineup.length !== 5) {
            alert("You must select exactly 5 players.");
            return;
        }
        activeLineup = [...tempLineup];
        renderActivePlayers();
        $('#subModal').modal('hide');
    }

    function formatMinutes(totalSeconds) {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function finishGame() {
        if (!confirm("Are you sure you want to finish and save this game?")) return;
        
        if (isClockRunning) toggleClock(); 

        let total = 0;
        Object.values(stats).forEach(s => total += s.points);

        const finalStats = {};
        Object.keys(stats).forEach(p => {
            const s = stats[p];
            s.minutes = formatMinutes(s.minutes_seconds);
            finalStats[p] = s;
        });

        const payload = {
            opponent: document.getElementById('opponent').value,
            date: document.getElementById('game-date').value,
            game_type: document.getElementById('game-type').value,
            team_score: total, 
            opponent_score: opponentScore, 
            player_stats: finalStats
        };

        const csrfToken = document.getElementById('csrf_token').value;

        fetch('/live-game/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if(data.success) {
                window.location.href = `/game/${data.game_id}`;
            } else {
                alert("Error saving game: " + (data.error || "Unknown error"));
            }
        }).catch(err => {
            alert("Network error occurred.");
            console.error(err);
        });
    }
</script>
{% endblock %}
